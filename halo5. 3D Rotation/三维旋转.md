# 现代冰晕研究漫谈(5): 三维旋转

在前一篇文章《[现代冰晕研究漫谈(4): 冰晕模拟仿真的朴素(naive)思路](https://zhuanlan.zhihu.com/p/512594144)》的末尾，我提到了怎么来描述冰晶的姿态，起了个头而没有展开。这一篇就稍微展开说说。三维旋转这个话题很大，扩展开去可以开出两三节专业课讲上一学期，这篇文章当然不会面面俱到，只是用一些尽量简单的例子，来给大家一个直观的印象，也为后面的几篇做好铺垫。

> 本篇关键词：代数结构，微分几何，数值分析，球面分布

### 代数结构

上一篇里我提到，如果用参数来描述一个任意的三维旋转，只需要三个参数就够了。而所有的三维旋转操作放在一起，构成了一个三维的流形（manifold）。虽然都可以用三个数来表示，可是这个流形并不等同于平直的欧氏空间 $\mathbb{R}^3$。举个最简单的例子，在三维的欧氏空间 $\mathbb{R}^3$ 中，两个元素（在这里也就是三维向量）可以加起来，并得到第三个元素，这是我们耳熟能详的向量加法
$$
\begin{align}
\mathbf{a}+\mathbf{b} &= \mathbf{c} \\[0.8em]
\begin{bmatrix}
x_a \\
y_a \\
z_a
\end{bmatrix} +
\begin{bmatrix}
x_b \\
y_b \\
z_b
\end{bmatrix} =
\begin{bmatrix}
x_a + x_b \\
y_a + y_b \\
z_a + z_b
\end{bmatrix} &=
\begin{bmatrix}
x_c \\
y_c \\
z_c
\end{bmatrix}
\end{align}
$$
可是在我们这里对冰晶姿态就不能直接这么做。对于冰晶的某一个姿态 $(\lambda_a, \varphi_a, \theta_a)$，（为方便起见，在上下文明确的情况下，我们把这三个参数分别叫做经度、纬度、转角），加上另一个姿态 $(\lambda_b, \varphi_b, \theta_b)$，其结果是不是可以看成是经度方向上等于 $\lambda_a + \lambda_b$，纬度方向上等于 $\varphi_a + \varphi_b$，转角等于 $\theta_a + \theta_b$ 呢？这肯定是不行的，比如纬度方向 $\varphi_a + \varphi_b$ 可能会超出 $\pm 90^\circ$ 范围，于是这个相加的结果并不是一个合法的冰晶姿态。

我们遇到的情况，用代数的语言来说就是，冰晶姿态（或者说三维旋转）这个集合上，「加法」需要仔细定义，而不能简单地对三个参数沿用线性代数里的向量加法。同样道理，「数乘（标量乘法）」也是需要仔细定义的。换句话说，目前我们还没有在这个集合上建立 **代数结构**。

> 比如在三维欧式几何空间 $\mathbb{R}^3$ 里，我们已知一个初始点 $\mathbf{v}_0$ 和一个终末点 $\mathbf{v}_1$，那么中间状态可以表示为 $\mathbf{v}(t) = (1-t)\mathbf{v}_0 + t \mathbf{v}_1$，当 $t$ 从 0 到 1 遍历，我们就得到了所有的中间点（没错这就是大家熟悉的线性插值）。而如果没有加法和数乘，我们就没法做这样的运算，也就没法简单地让程序遍历所有状态。

### 插值

对于直接沿用线性代数的加法和数乘，我目前只提到了取值范围的问题，如果暂时不管各个参数的取值范围，强行按照线性插值来做呢？毕竟线性插值并不会超出初始状态和终末状态的范围，不会遇到取值范围的问题。

![对冰晶姿态插值](img/ch5_interp.gif)

可见，无论是对矩阵直接做线性插值，还是对经纬度+转角三个参数做线性插值，冰晶中间的旋转姿态都是有问题的。所以，即使不考虑取值范围，在考虑旋转的时候也没法直接沿用普通的加法和数乘。

> 到这里，如果有熟悉计算机图形学（computer graphics）的同学，或者有熟悉机器人学（robotics）的同学，可能就看出来了，三维欧式空间里向量的加法和数乘运算，对应的就是 LERP 插值（也就是线性插值），对于点线面这样对几何体是非常好用的。而我们这里的经纬度+转角三参数，实际上就是 yaw - pitch - roll 三个欧拉角，熟悉的同学马上可以想到，LERP 是不能直接在欧拉角上做插值的。冰晶姿态所需要的加法和数乘运算，对应的是 [SLERP](https://en.wikipedia.org/wiki/Slerp) 插值。在处理旋转有关的问题上，我们应该用 SLERP 插值而不能用 LERP 插值。
> 

我们需要仔细考虑三维旋转群 $\mathrm{SO}(3)$ 上面应该具有怎样的代数结构，应该构建怎样的运算关系，最起码，我们要定义好加法和数乘（从而可以进行插值、遍历）。

> 我们不妨看看 SLERP 是怎么做的呢？这里不打算深入谈论细节，但从简单的出发点来说，一个合理的思路是，对首末状态的经纬度坐标 $\lambda, \varphi$（也就是 yaw - pitch 两个欧拉角），当作球面上的两个点，沿着经过两个点的大圆圆弧进行插值，SLERP 就是告诉你沿着大圆圆弧进行插值应该怎么做。下图来自 wiki [SLERP](https://en.wikipedia.org/wiki/Slerp)
>
> ![SLERP](img/Slerp_factor_explanation.png)
>
> 这是没有考虑第三个转角 $\theta$ 的参数，如果考虑进来，我们就需要稍微修改一下原版的 SLERP，使得它对单位四元数进行操作。我们不直接对欧拉角进行计算，而是通过四元数转换一下，就仍然可以沿用 SLERP 的算法了。

虽然我们从工程的角度可以按照一定规则来处理插值和遍历（比如经纬度用 SLERP 插值 + 转角用线性插值），可是给人感觉很不优雅而且容易算错。如果可以用欧拉角来算的话，用四元数怎么算，用矩阵怎么算？这些不同的计算方式之间有什么关系？以及，为什么一定要用特定的参数来表达，才能计算呢？明明「旋转」这个操作，完全不用依赖于参数，是一个「实际可以做到」的操作。

### 内禀性质与微分几何

这些思考反映了现代几何学（以及以此为基础建立的现代物理学）的一个很基本的思想——寻找不变性、寻找「内禀」性质。

什么意思呢？举个简单例子，就好比对一个球面来说，我们知道球面是弯曲的，是有曲率的，这个曲率是球面本身的性质。不管我们用直角坐标系、圆柱坐标系、球坐标系来描述这个球面，都不改变这个球面有曲率这个事实。如果我们要去计算的话，使用不同的坐标系一定能得到同样的曲率结果。曲率这个性质就是球面的内禀性质，不依赖于坐标系的选取。

最早高斯（就是那个无处不在的高斯）就深入地思考了这个问题，发现了「高斯绝妙定理」，描述了曲面的「高斯曲率」。从这个定理的名字也可以看出来，高斯对这个发现是多么的满意；能让高斯这样的大神如此满意，这条定理的地位就是这么高，可以说这是微分几何的开山鼻祖了。

撇开一些数学上的细节，我们目前的需求是要对「旋转」进行「插值」，在上面的分析中我们知道需要定义加法和数乘。而换一个角度来看，插值意味着遍历首末状态中间的所有状态，意味着找到一条「最短路径」来连接首末状态。而「最短路径」就是一个几何体上面的内在性质了，只要这个空间定义了「距离」，那么最短路径就存在，并且不依赖于坐标系的选取。

进一步讨论的话就要涉及到流形上的微分了（其实等价于定义加法和数乘，微分是取了极限状态），而讨论 $\mathrm{SO}(3)$ 上的微分就自然引出了李群和李代数。从这个角度来看李代数，是很自然的。有了微分就可以进一步讨论「最短路径」，在流形上叫作「测地线」。两个旋转状态中间的任何状态，用李代数来计算的话，形式上和平直欧氏空间里做线性插值是一样的（这里 $\mathbf{X}$ 和 $\mathbf{Y}$ 是首末两个旋转姿态对应的李代数）。

$$
\begin{align}
\mathfrak{so}(3)\quad &\to \quad \mathrm{SO}(3) \\[0.8em]
(1-t)\mathbf{X}+t\mathbf{Y}\quad &\mapsto \quad
\exp\big((1-t)\mathbf{X} + t\mathbf{Y}\big)
\end{align}
$$

这个形式，其实和四元数的 SLERP 就是一回事了。

李群和李代数是非常大的一块内容，可以有很多不同角度的理解；本篇从如何自然拓展欧氏空间的角度，类比欧氏空间里的运算（加法、数乘、微分），从「不变量」（最短路径）的角度自然延伸出一系列的概念。为读者提供一个视角。

知乎上讲解微分几何和 $\mathrm{SO}(3)$ 群的文章有很多，个人很推荐 [东云正树](https://www.zhihu.com/people/addf05a0e14de70d36baf1223c0a01e6) 的一系列文章（比如 [群论 (Group Theory) 终极速成 / SU(2) 与 SO(3) 的梦幻联动](https://zhuanlan.zhihu.com/p/341625428)，这篇很详细地讨论了 $\mathrm{SU}(2)$ 和 $\mathrm{SO}(3)$ 的联系，两者背后对应同样的李代数）

### 球面上的均匀分布

在工程上我们经常需要在球面上均匀抽样，一个很自然的问题是，如果球面上有 $N$ 个点是均匀分布的，那么相邻两点之间的角距离 $\theta_m$ 应该是一个什么分布？

由于对称性，我们可以首先固定一个点，然后再均匀抽取第二个点。球面上的均匀分布，意味着第二个点落在角半径 $\alpha$ 的球冠内的概率与球冠面积成正比。所以第二个点与第一个点之间的角距离分布应该是

$$
P(\theta < \alpha) = \frac{1}{2}(1-\cos\alpha)
$$

如果总共有 $N$ 个点，那么一共有 $N-1$ 个角距离，这些角距离分布都是同样的。对独立同分布的若干随机变量，其最小值分布（也就是我们要求的相邻两点之间的角距离分布）是

$$
\begin{align}
P(\theta_m < \alpha) &= 1 - \big(1 - P(\theta < \alpha)\big)^{N-1} \\
&= 1 - \frac{1}{2^{N-1}}(1 + \cos\alpha)^{N-1}
\end{align}
$$

上面这是累积概率分布，对 $\alpha$ 求导就得到概率密度分布：

$$
p(\theta_m = \alpha) = \frac{N-1}{2}\big(\frac{1+\cos\alpha}{2}\big)^{N-2}\sin\alpha
$$

我们拿三维球面举个例子。要产生三维球面上的均匀分布有许多方法，我这里挑一个比较偷懒的办法——生成 $N$ 个三维高斯变量，然后对他们归一化，就得到了三维球面上的 $N$ 个均匀分布的点。然后计算最近两点之间的角距离，画一个直方图：

![球面均匀分布](img/hist01.png)

可以看到和我们理论计算的分布形式是非常吻合的。

> 这里有一个数值稳定性方面的问题，当采样点个数 $N$ 很大的时候，角度 $\alpha$ 会很小，于是 $\cos\alpha$ 会很接近 1，$(1+\cos\alpha)$ 会很接近 2，所以公式里的 $((1+\cos\alpha)/2)^{N-2}$ 就会变成在一个很接近 1 的值上做一个很大的指数运算，这会导致数值精度下降。
>
> 直观地想 $\alpha$ 应该是接近 $1/\sqrt{N}$ 的数量级，做个变量代换设 $\alpha = k/\sqrt{N-2}$，那么上面的概率密度可以写成
>
> $$
> \begin{align}
> p &=\frac{N-1}{2}\big(\frac{1+\cos k/\sqrt{N-2}}{2}\big)^{N-2}
> \sin k/\sqrt{N-2} \\[0.5em]
> &= \frac{N-1}{2}\big(\frac{1 + 
> 1 - \frac{k^2}{2(N-2)} + \frac{k^4}{24(N-2)^2} + \cdots }{2}\big)^{N-2}
> \big( \frac{k}{\sqrt{N-2}} - \frac{k^3}{6(N-2)\sqrt{N-2}} + \cdots \big) \\[0.5em]
> &\sim \frac{k(N-1)}{2\sqrt{N-2}}\big(1 - \frac{k^2/4}{N-2} \big)^{N-2} \\[0.5em]
> &\sim \frac{k(N-1)}{2\sqrt{N-2}} \exp \big(-\frac{k^2}{4} \big) \\[0.5em]
> &= \frac{\alpha(N-1)}{2} \exp \big(-\frac{\alpha^2(N-2)}{4} \big)
> \end{align}
> $$
>
> 其中第三行的近似是忽略高阶项，第四行的近似是利用极限 $\lim_{n\to\infty}(1+x/n)^n=e^x$。当 $N$ 很大而中间浮点数精度有限（比如只有单精度），用这个式子比直接计算三角函数的指数会更精确。
>
> ![数值精度](img/numerical_err.png)

### $\mathrm{SO}(3)$ 群与 $\mathbb{R}^4$ 单位球面

在前面的讨论中我们看到，$\mathrm{SO}(3)$ 群可以平直嵌入 $\mathbb{R}^4$ 空间，形成一个单位球面（严格讲，是对径认同的单位球面，参见上面东云正树的文章）。那么，这个单位球面上的均匀分布，是不是等价于 $\mathrm{SO}(3)$ 本身的「均匀分布」呢？

当然，我们得首先定义一下 $\mathrm{SO}(3)$ 上的「均匀分布」是什么样的。在我们的场景里，一个很自然的想法是，让冰晶主轴的经纬度 $\lambda, \varphi$ 在二维球面上均匀分布，让冰晶旋转角 $\theta$ 在 0~360° 之间均匀分布。我们把这样的 $(\lambda,\varphi,\theta)$ 欧拉角参数转换成单位四元数（注意相反的两个四元数实际上对应同一个旋转，这也是上面东云正树文章中所说的「对径认同」的含义，所以在这里四元数的样本数量是欧拉角样本数量的两倍），然后统计一下相邻两个样本之间的角距离：

![SO3均匀分布](img/hist02.png)

可以看到，这个角距离分布和上一小节的球面均匀分布是很像的。上一小节我们的推导是基于 $\mathbb{R}^3$ 中的二维球面进行的，把计算球冠面积的部分换成四维的公式，稍加改动我们就可以得到 $\mathbb{R}^4$ 中球面情形的表达式，
$$
P(\theta_m < \alpha) = 1 - \big(1-\frac{2\alpha-\sin2\alpha}{2\pi}\big)^{N-1}
$$
这是累积概率分布函数，然后对 $\alpha$ 求导得到概率密度函数
$$
p=\frac{2(N-1)}{\pi} \sin^2\alpha
\big(1-\frac{\alpha}{\pi} + \frac{\sin 2\alpha}{2\pi}\big)^{N-2}
$$
同样的，我把这个理论结果也一起画在图上，可以看出和实际的统计结果是一致的。

> 注意这里同样有数值稳定性方面的问题，给读者朋友留个思考题，这里更稳定的方式是怎么计算呢？

虽然我们这里不进行详细的数学上的推导，但从我们这个简单的统计结果可以间接说明我们的猜想是对的，单位四元数的球面均匀分布，等价于 $\mathrm{SO}(3)$ 本身的「均匀分布」。这个结论对我们的程序比较有帮助，在工程角度上我们可以选择任意一种实现，甚至在不同的处理场景下选择好用的一种。

> 也许你会说，用欧拉角三参数很容易理解，而且没有冗余，不能所有的场景都用吗？
>
> 的确如此，虽然欧拉角三参数容易理解，但他存在两个奇点——南北极点。在南北极点，经度值可以为任意值。如果一条路径经过了南北极点附近，在数值上会产生巨大的变化，这在一些计算上是不利的。这个时候使用单位四元数就会更容易计算，而且也更稳定。
