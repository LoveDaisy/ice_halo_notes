# 现代冰晕研究漫谈(2): 森罗万象百步穿杨

在序言《[现代冰晕研究漫谈(0): 风起青萍之末](https://zhuanlan.zhihu.com/p/461810067)》中我提到，这个系列文章希望将一些更现代的数学工具、计算机程序处理等手段引入冰晕研究，给这个古老的领域带来一些新思路。我看来，这个领域有点像是伽罗瓦之前人们对代数方程的研究，从一元二次方程的求根公式，到三次方程到四次方程，多是仰赖经验和观察，比较零散；而伽罗瓦以群论为基础，用代数域扩张这个强大的武器，**彻底终结** 了「一元 x 次方程的求根公式」这个话题。

冰晕研究中，我们常常会讨论某一种晕是怎么形成的，常常会讨论有没有新的晕没有被发现，那么有没有办法，**从理论上** 完全确定某种晕是不是可能存在呢？这当然是可以的，不管是大家都用的商业软件 HaloPoint 2.0，还是我写的模拟软件，都可以进行模拟。如果怀疑某种晕是不是存在，按照预想的光路和冰晶，跑一下模拟，就可以看到结果了。比如我想看看片晶（Plate orientation）的 1-3 光路是什么结果，模拟一下就知道是环天顶弧。

![1-3光路的环天顶弧](img/rp1-3_plt0.5_s25_i2_note.jpg)

之前的冰晕研究基本都是走的这个路线，先设计（猜想）再模拟（计算）验证。经过前人不断的努力，依靠这种方法积累了非常多的资料，从这些资料中人们对冰晕进行归纳整理。这方面的集大成者我认为是《Atmospheric Halos and the Search for Angle x》这本书了，作者 Walter Tape 和 Jarmo Moilanen，都是青史留名（有以他们名字命名的冰晕）的大佬，强烈推荐去读一读学习一下。

> 这里岔开去说两句，这本书的体系非常系统，给我很大的启发。里面的研究手段偏向「几何」，颇有点牛爵爷当年写《自然哲学之数学原理》的风范，用纯几何语言证明角动量守恒、行星运动的椭圆轨道等等，要看懂颇为需要一些空间想象能力，只能说大师不愧是大师。
>
> 后续 Tape 还出了《Streetlight Halos》，更加登峰造极，可以强烈体会出大师的功力深厚。

这种模拟验证的思路，非常依赖于预先设计的光路，如果预先不知道某一条光路，也就无法模拟对应的冰晕了。可是设计光路还是需要一些经验的，尤其是对于一些比较长的光路，即使是这个领域的专家，没有先验知识的情况下也会遗漏。比如特里克尔（R.A.R. Tricker）在一开始解释以他名字命名的特里克尔弧的时候，都遗漏了非常重要的一类，从同一个底面进出的光路（比如 1-2-3-5-1），而只列举了从棱柱侧面进出的光路（比如 3-1-5-7-4）。

<img src="img/Tricker_arc_raypath.png" alt="两种 Tricker 弧的光路" style="zoom:28%;" />

那么问题来了，我作为程序员的坏毛病一下就发作起来，很容易就想到这样反过来的思路：我可不可以不用预先去设计光路，而是直接把所有可能的光路都列举出来，然后一一用程序去模拟验证呢？上一篇文章《[现代冰晕研究漫谈(1): 迷镜千幻不离宗](https://zhuanlan.zhihu.com/p/462717356)》其实就是为了这个目的做的铺垫，本篇文章将把下半段继续讲下去。

简单穷举是容易的，棱柱冰晶一共 8 个面，长度不超过 N 的光路一共会是 $8^N$ 种，简单的中学排列组合题罢了。可是我们不能直接把这么多光路都扔给程序去模拟计算，数量太大了。于是，可以利用上一篇文章里提到的对称性，极大降低光路的数量。比如长度不超过 4 的光路一共 8^4 = 4096 种，而考虑 $D_{6h}$ 对称性，规约之后就只有 196 种不同的光路，剩下不到 5% 的数量。光路长度越长，这个节约的比例就越大，对于长度不超过 6 的光路来说，这两个数字分别是 262144 和 7700，比例只有不到 3% 了。

好了，我们现在把穷举的光路按照对称性规约完毕，大大减少了可能性，然后就可以扔给程序去模拟吗？还不行，这中间还有大量几何上不成立的光路，比如 1-3-1，比如 3-4-3-4；如果盲目地把这种光路扔给程序计算，只是无谓地浪费时间。这种光路要怎么排除呢？

（插图）

我们知道，光路的镜面反射，等价于把镜面前的所有东西，镜像对称到镜面后，然后光线沿着原来的方向继续前进，就好像镜面不存在一样——我们把这种操作叫做反射展开。

（插图）

所有长度大于 2 的光路，必然存在内部的镜面反射。我们把所有的内部每一次的镜面反射都展开，如果是一条正常的光路，那么这些内部反射的光路将展开为一条直线。而每一次的镜面（也就是冰晶的一个个表面），都变成了一个个三维空间中的多边形，加上首尾两个面，共同形成了一个「光线走廊」。

（插图）

这样就容易看清楚了，如果这个光线走廊，可以找到一个角度，存在一条直线依次穿过每一个多边形的内部从而贯通整个走廊，那么这条光路就是几何上成立的；如果做不到，中间有多边形互相遮挡，以至于无法首尾贯通，那么这条光路就是几何上不成立的。

说起来容易，那具体要怎么求解呢？下面开始一点点数学。

首先用更数学的语言来重新描述一下我们的问题：给定一些空间多边形，找到是否存在一条直线，贯穿每一个多边形的内部。假设空间多边形是 $\mathbf{P}_i$，它的顶点是 $\boldsymbol{p}_{i,j}$，每一个都是一个 d 长度的列向量，那么多边形可以把这些顶点放在一起来表示成一个矩阵 $\mathbf{P}_i=\left[\boldsymbol{p}_{i,1},\; \boldsymbol{p}_{i,2},\;\dots\right]$ ，在我们这个场景下，冰晶（不管是棱柱还是棱锥）的表面都是凸多边形，所以根据线性代数的知识我们知道，对于任意一个 **凸多边形** 内部的点，都可以表示为各个顶点的 **凸组合**：
$$
\boldsymbol{q}_i = \sum_j \alpha_{i,j} \boldsymbol{p}_{i,j}, \quad \text{s.t. } \sum_j \alpha_{i,j} = 1, \quad 0 < \alpha_{i,j} < 1
$$
对于第 k 个多边形来说，我们希望它内部的点 $\boldsymbol{q}_k$ 位于首尾两个多边形内部点 $\boldsymbol{q}_1$ 和 $\boldsymbol{q}_N$ 之间的连线上，也就是满足：
$$
\boldsymbol{q}_k = s_k \boldsymbol{q}_1 + t_k \boldsymbol{q}_N, \quad \text{s.t. } s_k + t_k = 1, \quad 0 < s_k, t_k, < 1
$$
于是，对于「是否能找到一条直线贯通所有凸多边形」就转化为「寻找满足以上条件的 $\alpha_{i,j}$，$s_k$，$t_k$ 是否存在」这样一个数学问题。仅仅转化成一个数学描述我们并不能掉以轻心，「满足一定约束条件的解是否存在」有时候是非常难求解的。不过幸运的是，我们这个问题有它的便利之处，这个约束条件是 **凸函数**，我们可以把一部分的约束条件转化为求解一个 **凸优化** 问题。众所周知，当你把问题转化为凸优化问题之后，基本就等于解决了，凸优化问题往往有着高效的求解算法：
$$
\begin{align}
\min \quad & \sum_{k=2}^{N-1} \|s_k \boldsymbol{q}_1 + t_k \boldsymbol{q}_N - \boldsymbol{q}_k\|^2 \\
\text{s.t.} \quad & \boldsymbol{q}_i = \sum_j \alpha_{i,j} \boldsymbol{p}_{i,j}, \quad i=1,\dots,N \\
& \sum_j \alpha_{i,j} = 1, \quad s_i + t_i = 1 \\
& 0 < \alpha_{i,j}, s_i, t_i < 1
\end{align}
$$
从前面的分析可以知道，如果原始约束条件下存在解，那么这个凸优化问题的目标函数最小值一定是 0；而如果这个凸优化问题的最优解大于 0，那么等价于原始约束条件下解不存在。具体求解的代码就不放上来了，我比较懒，直接用了 matlab 里自带的 `fmincon` 函数，使用内点法（Interior point）进行求解的。

问题到这里似乎解决了，我们来看一个实际的例子吧，比如 1-3-2 光路。这个光路比较简单，我们肉眼都能看出来，这个「光线走廊」是成立的，最简单来说，比如我们连接这三个（光路展开后）的多边形中心，就在一条直线上了，甚至都不用仔细求解这个优化问题（当然，不放心可以代入看看，目标函数确实是 0，而且满足所有的约束条件）。

（插图）

一切都很完美，只有一点——这条光路在光学上不成立。这条直线在底面（1 和 2 面）上的出（入）射角太大了，根本不可能有实际光线可以完成这样的折射，内部光线会发生全反射而不会穿出底面到外面去（相反外面的光线也不会以这个角度穿过底面进入冰晶内部）。

所以仅仅满足 **几何约束** 条件还不够，还要进一步满足 **光学约束** 条件。

光学约束条件就比较简单了，我们有了一条贯穿所有多边形的直线，只要计算一下这条直线与首尾两个表面法线的夹角，让这个夹角尽量小，就可以了。简单起见，可以直接加到目标函数里去，变成：
$$
\sum_{k=2}^{N-1} \|s_k \boldsymbol{q}_1 + t_k \boldsymbol{q}_N - \boldsymbol{q}_k \|^2 - \lambda \min\left\{ -\hat{\boldsymbol{r}} \cdot \hat{\boldsymbol{n}}_1,\; \hat{\boldsymbol{r}} \cdot \hat{\boldsymbol{n}}_N \right\}
$$
这里 $\hat{\boldsymbol{n}}$ 表示表面的法向量，$\hat{\boldsymbol{r}}$ 表示从第一面到最后一面贯穿的直线的单位向量，这两个向量点乘就能得到光线与法向量之间夹角的余弦值 $\cos \theta = \hat{\boldsymbol{r}} \cdot \hat{\boldsymbol{n}}$ 。由于表面的法向量总是指向晶体外部，所以首尾两项的符号是相反的。取首尾表面上的夹角较大者（因而是余弦值较小者）加入目标函数。这里非常幸运的是，新加入的这一项，还是凸函数，使得这个问题还是容易求解。

我们重新再计算一次 1-3-2 这个光路，这一次，连接三个多边形中心的直线，就不再是最优解了，经过一系列迭代求解步骤，我们得到了最优目标函数值为 -0.998，注意到在满足几何约束情况下，上面目标函数的第一项自动为 0，那么这意味着 $\cos \theta = 0.998$，非常接近 1，也就是说入（出）射角非常接近 0，这条光线是贴着底面的一条棱边入射，经过侧面的一次反射，再从另一个底面贴着棱边出射。所以这条光路不仅是几何上成立，光学上也成立。

（插图）

我们再看一个几何上成立，但是光学上不成立的例子，比如 1-3-4 这个光路，同样满足几何约束条件（感兴趣的同学不妨动手画一画，手工验证一下确实成立）。但求解最后的优化问题，最优解的目标函数值是 -0.266，对应光线与法线的最小夹角 $\theta = 74.5^\circ$ 这个角度大于了冰晶的临界角 $\theta_c = \arcsin(1/n) = 49.8^\circ$，所以光学上不成立。
