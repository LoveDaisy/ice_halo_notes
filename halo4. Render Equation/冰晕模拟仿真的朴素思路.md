# 现代冰晕研究漫谈(4): 冰晕模拟仿真的朴素(naive)思路

> 本篇关键词：模拟仿真，渲染方程，遍历（brute force），naive!

前面的几篇文章探讨了一些现代手段在冰晕研究中的应用，利用群论研究光路的对称性《[迷镜千幻不离宗](https://zhuanlan.zhihu.com/p/462717356)》，利用计算几何的算法遍历搜索所有可能的光路《[计算机遍历、搜索、优化](https://zhuanlan.zhihu.com/p/469793197)》，利用线性代数分析平行光路的晕《[平行光路的各种弧和晕](https://zhuanlan.zhihu.com/p/485848284)》；读者们可以看到，我们借助这些现代手段，能更直观、更深刻地理解冰晕背后的本质。

我思考问题有个习惯，总是喜欢从各种不同的角度来想，正着看反着看，都去尝试一下。前面的这几篇文章就像正面攻击，是从理论的角度进行探索；而冰晕研究中同样离不开反向的探索——借助仿真程序，对冰晕进行模拟。本专栏以前有一篇文章《[绘光：冰晕模拟的故事](https://zhuanlan.zhihu.com/p/38975467)》就简单介绍了我开发冰晕仿真程序的一些故事，而本篇就从模拟仿真的角度来简单探讨一番。

> 从本篇开始，接下来几篇都会从模拟仿真的角度与读者朋友们一起探讨。与单纯的理论分析一样，这也是一个精彩纷呈的世界。

以最朴素的思路来看，冰晶就像是一个「函数」，给定入射光，给定其自身的姿态，就会得到出射光。在实际冰晕发生的情况下，短时间内太阳的位置可以看做是已知并且固定的，也就是说入射光是一个固定值，那么出射光的方向就只与冰晶的姿态相关。为简洁起见，下面讨论的时候不必每一次都啰嗦一大段话，我们把冰晶的这个「函数」用记号来表示：
$$
d: (\mathbf{p}, k) \mapsto d(\mathbf{p},k) \in \mathbb{R}^3
$$
这里 $\mathbf{p}$ 代表冰晶自身的姿态（pose）是一个向量（这里我们暂时先不讨论这个向量是几维的），$k$ 表示入射光线从冰晶的哪一个表面入射，$d$ 表示映射关系。

此外，冰晶姿态不止影响了出射光的方向，还有强度。我们知道，根据 [Fresnel 方程](https://en.wikipedia.org/wiki/Fresnel_equations) 光线入射介质表面的角度不同，折射光和反射光分量的光强也是不同的。在冰晶这里也是一样，冰晶不同的姿态导致各个面相对入射光有不同的角度，从而导致出射光线的强度发生变化。对我们来说，这就是另一个「函数」——把冰晶的姿态（向量）映射到出射光线强度（标量）：
$$
w: (\mathbf{p}, k) \mapsto w(\mathbf{p}, k) \in \mathbb{R}
$$

> 这两步很直观，很容易理解。其实整个冰晕的模拟仿真就建立在这样直观的概念基础上，（到目前为止）并没有高深莫测的理论，大家可放心食用（雾

这里我们把冰晶内部的折射反射过程全部略去，只是把冰晶看做一个「黑盒」，一个「函数」。给定一个冰晶的姿态 $\mathbf{p}$，以及光线入射的表面 $k$，就可以得到描述出射光线的参量 $(\mathbf{p}, w)$，出射光线将沿着 $\mathbf{p}$ 方向按照 $w$ 的强度射出。

好了，我们准备好回答最重要的问题了：在人眼看来（或者在模拟程序的相机看来），视野里的某一个点到底该多亮呢？很简单，逻辑上我们只需要两步：

1. 遍历冰晶所有的可能姿态，遍历冰晶所有的表面，就可以得到所有的出射光线；
2. 从所有的出射光线里挑选出一些光线，其方向恰好是视野里某一点对应的方向，把这些光线的强度都加在一起，就得到了视野里这一点的亮度了。

（插图）

这个思路听起来非常暴力，可是却很直白很容易理解。而且，如果我们想要知道视野里其他点的亮度，只要在第二步里不断改变筛选条件，筛选出视野里不同方向对应的出射光线，再做计算就可以了。甚至于更进一步，如果我们不做筛选，只是做光强度的叠加，那么我们就得到了全天 360 度所有方向的整体光强分布情况。

> 从数学上来说，冰晶所有可能的姿态是一个连续的空间分布，那么这里对冰晶姿态的「相加」操作实际上应该是一个「积分」操作，可以写成这样的形式：
> $$
> I(\mathbf{d}) = 
> \int\limits_{\mathclap{\substack{
>   \mathbf{p} \,\in\, \big\{\mathbf{p}\,\big|\, d(\mathbf{p}, k)=\mathbf{d} \big\} \\[0.5em]
>   k = 1,2,\dots
> }}}
> w(\mathbf{p},k) \;\text{d}\mathbf{p}
> $$
> 这里 $\mathbf{d}$ 表示视野里某一点对应的方向。这个形式是按照上面的两步逻辑写的，方便顺着思路理解。而从另一个角度，如果有熟悉计算机图形学的朋友们看到这里，应该会想到计算机图形学里大名鼎鼎的渲染方程（[Render equation](https://en.wikipedia.org/wiki/Rendering_equation)）：
> $$
> L_o(\mathbf{x},\lambda,\omega_o,t) = L_e(\mathbf{x},\lambda,\omega_o,t) +
>   \int_\Omega f_r(\mathbf{x}, \omega_i, \omega_o, \lambda, t)
>   L_i(\mathbf{x},\lambda,\omega_i,t)
>   \big(\omega_i \cdot \mathbf{n} \big) \;
>   \text{d}\omega_i
> $$
> 冰晕模拟仿真这件事看起来就像是计算机图形学里的渲染，那么上面计算冰晕亮度的积分和这个渲染方程有什么关系呢？确实有点关系，我们按渲染方程里每一项来说明：
>
> 1. 在冰晕模拟里面，冰晶本身不发光，所有渲染方程里右边第一项 $L_e$ 就没有了，只剩下一个积分；
> 2. 积分里的第一项 $f_r$ 双向反射分布函数（[bidirectional reflectance distribution function](https://en.wikipedia.org/wiki/Bidirectional_reflectance_distribution_function)）其实就对应我们式子里的 $w(\mathbf{p}, k)$，只不过在冰晶折射反射的过程中所有行为都是确定的，不存在随机性，所以这就不是一个分布函数，而是简单的一个标量函数；
> 3. 积分里的第二项 $L_i$ 是描述光源的，在这里我们暂时把光源当做一个常量所以没有写到式子里；
> 4. 积分里的第三项是表示光线方向对结果的影响，在我们这里只有视野里某一点的方向需要计算，其他方向的光线不会贡献这一点的亮度，所以这一项在这里就退化成一个 0-1 函数，在我们的处理中就把他放到积分域里了，只有满足条件的光线才会筛选进来做积分。
>
> 从我们冰晕模拟的角度来看渲染方程就是这样的：
> $$
> \underbrace{ L_o(\mathbf{x},\lambda,\omega_o,t) }_{I(\mathbf{d})}  = 
> \underbrace{ L_e(\mathbf{x},\lambda,\omega_o,t) }_{0} +
>   \int_\Omega \underbrace{ f_r(\mathbf{x}, \omega_i, \omega_o, \lambda, t) }_{w(\mathbf{p}, k)} 
>   \;\; \underbrace{ L_i(\mathbf{x},\lambda,\omega_i,t) }_{\text{constant}}
>   \underbrace{ \big(\omega_i \cdot \mathbf{n} \big) }_{\text{integral region}} \;
>   \text{d}\omega_i
> $$
> 所以根本上来说，我们的仿真方程就是渲染方程，只是针对我们冰晕的场景改写成了另一个形式罢了。不过要是写成渲染方程看起来就还挺有逼格的，是吧？（笑
>
> 计算机图形学的一大目标，就是使用各种算法和技巧来加速计算这个渲染方程，本质上是牺牲精确性来提高速度。而我们冰晕模拟恰恰需要精确性，因此我们并没有太多手段可以帮助加速。这一点以后有机会再展开说吧。
>
> 这一段看不懂没关系，这篇文章主要也不是讲这个公式的，这里就当做「哦有这么个东西」就行了。

在上面两步走逻辑的第一步里，我们需要遍历冰晶所有可能的姿态，那么问题来了——冰晶的姿态向量 $\mathbf{p}$，到底是几维的？

从直观的角度想，冰晶的姿态其实就是对其三维空间旋转状态的一个描述，不需要包含平移。而三维空间的旋转是一个 $\mathrm{SO}(3)$ 群，我们通常会用一个旋转矩阵来代表群里的元素（旋转变换）。三维的旋转矩阵有 9 个数，那么冰晶的姿态向量是 9 维的吗？不尽然，因为旋转矩阵有一些额外的约束（比如 $\mathbf{RR}^T=\mathbf{R}^T\mathbf{R}=\mathbf{I}$，这里实际上行列各有三个约束），所以旋转矩阵的自由度小于 9。

从另一个角度看，我们知道可以用四元数（Quaternion）来表示一个三维旋转，那么冰晶姿态向量应该是 4 维的吗？也不是，四元数表示三维旋转是有冗余的，我们一般需要做归一化，使用单位长度的四元数。

从这些侧面角度我们似乎可以猜到，三维旋转的内禀维度是三，或者说，$\mathrm{SO}(3)$ 群对应一个三维的流形，这个流形可以平直地嵌入一个 $\mathbb{R}^4$ 空间（单位四元数）。事实上正是如此，我们可以使用三个参数来描述冰晶的旋转：两个参数 $\lambda, \varphi$ 用来表示冰晶主轴的指向（用球面经纬度表示），一个参数 $\theta$ 表示冰晶绕主轴的旋转。这正是前面文章中我所使用的符号。

虽然我们用三个参数描述了，但很明显这个三维流形并不是一个平直的 $\mathbb{R}^3$ 空间，我们在遍历所有可能性的时候就需要特别小心。如果不注意的话，很可能导致我们以为是均匀遍历，但实际上并没有真正均匀遍历，那么仿真的结果就会失真了。我们在下一篇来详细讨论这个话题吧，本篇先就此结束。